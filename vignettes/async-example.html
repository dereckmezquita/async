<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Gábor Csárdi" />

<meta name="date" content="2022-07-23" />

<title>Examples for the async package</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Examples for the async package</h1>
<h4 class="author">Gábor Csárdi</h4>
<h4 class="date">2022-07-23</h4>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(async)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(desc)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span></code></pre></div>
<div id="find-the-fastest-cran-mirror-in-the-us" class="section level3">
<h3>Find the fastest CRAN mirror in the US</h3>
<p>Get the URLs of all US CRAN mirrors, we’ll use this later.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mirrors <span class="ot">&lt;-</span> <span class="fu">getCRANmirrors</span>()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mirror_urls <span class="ot">&lt;-</span> mirrors<span class="sc">$</span>URL[mirrors<span class="sc">$</span>CountryCode <span class="sc">==</span> <span class="st">&quot;us&quot;</span>]</span></code></pre></div>
<p><code>response_time()</code> will be an async function that returns
the total response time of HEAD request to a single URL.</p>
<p><code>http_stop_for_status()</code> is similar to
<code>httr::stop_for_status()</code>, it throws an error if the status
code is 400 or higher. Should this (or other) error happen, we will just
return <code>Inf</code> for that URL.</p>
<p>We also add the URL to the result, as a name.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>response_time <span class="ot">&lt;-</span> <span class="fu">async</span>(<span class="cf">function</span>(url) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">http_head</span>(url)<span class="sc">$</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(http_stop_for_status)<span class="sc">$</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>(x) <span class="fu">setNames</span>(x[[<span class="st">&quot;times&quot;</span>]][[<span class="st">&quot;total&quot;</span>]], url))<span class="sc">$</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">catch</span>(<span class="at">error =</span> <span class="cf">function</span>(e) <span class="fu">setNames</span>(<span class="cn">Inf</span>, url))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Let’s try it, with a real CRAN URL, and a test one that returns an
HTTP 404 status code.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">response_time</span>(mirror_urls[[<span class="dv">1</span>]]))</span></code></pre></div>
<pre><code>## https://cloud.r-project.org/ 
##                     0.254737</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">response_time</span>(<span class="st">&quot;https://httpbin.org/status/404&quot;</span>))</span></code></pre></div>
<pre><code>## https://httpbin.org/status/404 
##                            Inf</code></pre>
<p><code>fastest_urls()</code> will run <code>response_time()</code> on
all supplied URLs, and stop as soon as 10 of them respond. Then we sort
the results, so the fastest response is first.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fastest_urls <span class="ot">&lt;-</span> <span class="fu">async</span>(<span class="cf">function</span>(urls) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  reqs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(urls, response_time)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">when_some</span>(<span class="dv">10</span>, <span class="at">.list =</span> reqs)<span class="sc">$</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>(x) <span class="fu">sort</span>(<span class="fu">unlist</span>(x)))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Let’s run it on the real data.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">fastest_urls</span>(mirror_urls))</span></code></pre></div>
<pre><code>##             https://cloud.r-project.org/ 
##                                 0.061559 
## https://repo.miserver.it.umich.edu/cran/ 
##                                 0.555456 
##             http://ftp.ussg.iu.edu/CRAN/ 
##                                 0.560155 
##          http://lib.stat.cmu.edu/R/CRAN/ 
##                                 0.576108 
##                   http://cran.wustl.edu/ 
##                                 0.619692 
##         https://cran.mirrors.hoobly.com/ 
##                                 0.666800 
##         https://ftp.osuosl.org/pub/cran/ 
##                                 0.726976 
##          https://rweb.crmda.ku.edu/cran/ 
##                                 0.784875 
##                   https://cran.case.edu/ 
##                                 0.811675 
##       https://mirrors.nics.utk.edu/cran/ 
##                                 0.819847</code></pre>
</div>
<div id="resolve-packages-from-github-and-urls" class="section level3">
<h3>Resolve packages from GitHub and URLs</h3>
<p>By <em>resolving</em> we mean 1. getting the <code>DESCRIPTION</code>
file of the package to be able to look up dependencies, and other
metadata, and 2. getting a download link, in case we want to download
the package later.</p>
<p>For this example we’ll implement two package types: 1. package on
GitHub, and 2. package file at a URL.</p>
<p>We start with GitHub packages, these are more complicated. First, we
need to set the <code>Accept</code> HTTP header when we talk to the
GitHub API, so define a helper function for that. We also set a GitHub
token to avoid GitHub rate limits, this should be in the
<code>GITHUB_PAT</code> environment variable.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>default_gh_headers <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  headers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Accept&quot;</span> <span class="ot">=</span> <span class="st">&quot;application/vnd.github.v3+json&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  pat <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;GITHUB_PAT&quot;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pat <span class="sc">!=</span> <span class="st">&quot;&quot;</span>) {</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    headers <span class="ot">&lt;-</span> <span class="fu">c</span>(headers, <span class="at">Authorization =</span> <span class="fu">paste</span>(<span class="st">&quot;token&quot;</span>, pat))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  headers</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Getting the <code>DESCRIPTION</code> file is easy, we just need to
hit the right API endpoint, and then extract the response.
<code>desc::desc()</code> creates a nice <code>desc::description</code>
object that can be queried.</p>
<p>We use <code>http_stop_for_status()</code> to error out, if the any
error happens, e.g. the repo or the file does not exist, and we cannot
access it, etc. We don’t catch this (or other) error here, so
<code>get_gh_description()</code> will throw an error to its
<code>$then()</code> (or <code>$when_any()</code> or
<code>$when_all()</code>) child, or to <code>synchronise()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>get_gh_description <span class="ot">&lt;-</span> <span class="fu">async</span>(<span class="cf">function</span>(user, repo)  {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  desc_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;https://raw.githubusercontent.com/&quot;</span>, user, <span class="st">&quot;/&quot;</span>, repo,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/HEAD/DESCRIPTION&quot;</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">http_get</span>(desc_url, <span class="at">headers =</span> <span class="fu">default_gh_headers</span>())<span class="sc">$</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(http_stop_for_status)<span class="sc">$</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>(resp) <span class="fu">rawToChar</span>(resp<span class="sc">$</span>content))<span class="sc">$</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>(txt) desc<span class="sc">::</span><span class="fu">desc</span>(<span class="at">text =</span> txt))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Test:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">get_gh_description</span>(<span class="st">&quot;jeroen&quot;</span>, <span class="st">&quot;curl&quot;</span>))</span></code></pre></div>
<pre><code>## Type: Package
## Package: curl
## Title: A Modern and Flexible Web Client for R
## Version: 4.3.3
## Authors@R (parsed):
##     * Jeroen Ooms &lt;jeroen@berkeley.edu&gt; [aut, cre] (&lt;https://orcid.org/0000-0002-4035-0289&gt;)
##     * Hadley Wickham &lt;hadley@rstudio.com&gt; [ctb]
##     * RStudio [cph]
## Description: The curl() and curl_download() functions provide highly
##     configurable drop-in replacements for base url() and download.file()
##     with better performance, support for encryption (https, ftps), gzip
##     compression, authentication, and other &#39;libcurl&#39; goodies. The core of
##     the package implements a framework for performing fully customized
##     requests where data can be processed either in memory, on disk, or
##     streaming via the callback or connection interfaces. Some knowledge of
##     &#39;libcurl&#39; is recommended; for a more-user-friendly web client see the
##     &#39;httr&#39; package which builds on this package with http specific tools
##     and logic.
## License: MIT + file LICENSE
## URL: https://github.com/jeroen/curl (devel) https://curl.se/libcurl/
##     (upstream)
## BugReports: https://github.com/jeroen/curl/issues
## Depends:
##     R (&gt;= 3.0.0)
## Suggests:
##     httpuv (&gt;= 1.4.4),
##     jsonlite,
##     knitr,
##     magrittr,
##     rmarkdown,
##     spelling,
##     testthat (&gt;= 1.0.0),
##     webutils
## VignetteBuilder:
##     knitr
## Encoding: UTF-8
## Language: en-US
## RoxygenNote: 7.1.2
## SystemRequirements: libcurl: libcurl-devel (rpm) or libcurl4-openssl-dev
##     (deb).</code></pre>
<p>Test non-existing repos, and other errors:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">get_gh_description</span>(<span class="st">&quot;jeroen&quot;</span>, <span class="st">&quot;curlqwerty&quot;</span>))</span></code></pre></div>
<pre><code>## Error in stop(http_error(resp)): Not Found (HTTP 404).</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">get_gh_description</span>(<span class="st">&quot;git&quot;</span>, <span class="st">&quot;git&quot;</span>))</span></code></pre></div>
<pre><code>## Error in stop(http_error(resp)): Not Found (HTTP 404).</code></pre>
<p>The next thing we need is the SHA of the commit we want to download.
For simplicity we always use the last commit of default branch here.
This function is very similar to the previous one otherwise.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>get_gh_sha <span class="ot">&lt;-</span> <span class="fu">async</span>(<span class="cf">function</span>(user, repo) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  commit_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;https://api.github.com/repos/&quot;</span>, user, <span class="st">&quot;/&quot;</span>, repo, <span class="st">&quot;/git/trees/HEAD&quot;</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">http_get</span>(commit_url, <span class="at">headers =</span> <span class="fu">default_gh_headers</span>())<span class="sc">$</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(http_stop_for_status)<span class="sc">$</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>(resp) {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      cdata <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(<span class="fu">rawToChar</span>(resp<span class="sc">$</span>content),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">simplifyVector =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>      cdata<span class="sc">$</span>sha</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Test:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">get_gh_sha</span>(<span class="st">&quot;jeroen&quot;</span>, <span class="st">&quot;curl&quot;</span>))</span></code></pre></div>
<pre><code>## [1] &quot;3f7f4ef8f39bd80d76a1179b85ce170c06287da2&quot;</code></pre>
<p>A small helper function to get a GitHub download URL from the user
name, repo name and the sha hash:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>get_gh_download_url <span class="ot">&lt;-</span> <span class="cf">function</span>(user, repo, sha) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">&quot;https://api.github.com/repos/&quot;</span>, user, <span class="st">&quot;/&quot;</span>, repo,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;/zipball/&quot;</span>, sha)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We are ready to write the GitHub resolver now. It will take a slug,
i.e. the <code>user/repo</code> form, and then query both the
<code>DESCRIPTION</code> file and the SHA hash. <code>when_all()</code>
resolves if both of them are done, and results a named list of both
pieces of data. Then we just create the download URL, and simply return
it with the already parsed <code>DESCRIPTION</code>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>resolve_gh <span class="ot">&lt;-</span> <span class="fu">async</span>(<span class="cf">function</span>(slug) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  slug <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(slug, <span class="st">&quot;/&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  user <span class="ot">&lt;-</span> slug[[<span class="dv">1</span>]]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  repo <span class="ot">&lt;-</span> slug[[<span class="dv">2</span>]]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  desc <span class="ot">&lt;-</span> <span class="fu">get_gh_description</span>(user, repo)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  sha  <span class="ot">&lt;-</span> <span class="fu">get_gh_sha</span>(user, repo)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">when_all</span>(<span class="at">desc =</span> desc, <span class="at">sha =</span> sha)<span class="sc">$</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>(x) {</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">url =</span> <span class="fu">get_gh_download_url</span>(user, repo, x<span class="sc">$</span>sha),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> x<span class="sc">$</span>desc)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Test:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">resolve_gh</span>(<span class="st">&quot;jeroen/curl&quot;</span>))</span></code></pre></div>
<pre><code>## $url
## [1] &quot;https://api.github.com/repos/jeroen/curl/zipball/3f7f4ef8f39bd80d76a1179b85ce170c06287da2&quot;
## 
## $description
## Type: Package
## Package: curl
## Title: A Modern and Flexible Web Client for R
## Version: 4.3.3
## Authors@R (parsed):
##     * Jeroen Ooms &lt;jeroen@berkeley.edu&gt; [aut, cre] (&lt;https://orcid.org/0000-0002-4035-0289&gt;)
##     * Hadley Wickham &lt;hadley@rstudio.com&gt; [ctb]
##     * RStudio [cph]
## Description: The curl() and curl_download() functions provide highly
##     configurable drop-in replacements for base url() and download.file()
##     with better performance, support for encryption (https, ftps), gzip
##     compression, authentication, and other &#39;libcurl&#39; goodies. The core of
##     the package implements a framework for performing fully customized
##     requests where data can be processed either in memory, on disk, or
##     streaming via the callback or connection interfaces. Some knowledge of
##     &#39;libcurl&#39; is recommended; for a more-user-friendly web client see the
##     &#39;httr&#39; package which builds on this package with http specific tools
##     and logic.
## License: MIT + file LICENSE
## URL: https://github.com/jeroen/curl (devel) https://curl.se/libcurl/
##     (upstream)
## BugReports: https://github.com/jeroen/curl/issues
## Depends:
##     R (&gt;= 3.0.0)
## Suggests:
##     httpuv (&gt;= 1.4.4),
##     jsonlite,
##     knitr,
##     magrittr,
##     rmarkdown,
##     spelling,
##     testthat (&gt;= 1.0.0),
##     webutils
## VignetteBuilder:
##     knitr
## Encoding: UTF-8
## Language: en-US
## RoxygenNote: 7.1.2
## SystemRequirements: libcurl: libcurl-devel (rpm) or libcurl4-openssl-dev
##     (deb).</code></pre>
<p>Resolving a package at an HTTP URL is much simpler, it needs a single
HTTP request, because we simply need to download the package to get the
DESCRIPTION file. We place the downloaded package in a temporary file
(with the same file name), and return a <code>file://</code> URL to this
file.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>resolve_url <span class="ot">&lt;-</span> <span class="fu">async</span>(<span class="cf">function</span>(url) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(tmpdir <span class="ot">&lt;-</span> <span class="fu">tempfile</span>())</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  dest <span class="ot">&lt;-</span> <span class="fu">file.path</span>(tmpdir,  <span class="fu">basename</span>(url))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">http_get</span>(url, <span class="at">file =</span> dest)<span class="sc">$</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(http_stop_for_status)<span class="sc">$</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">then</span>(<span class="cf">function</span>() {</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      dest <span class="ot">&lt;-</span> <span class="fu">normalizePath</span>(dest)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">url =</span> <span class="fu">paste</span>(<span class="st">&quot;file://&quot;</span>, <span class="fu">normalizePath</span>(dest)),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> desc<span class="sc">::</span><span class="fu">desc</span>(dest))</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Test:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>curl20_url <span class="ot">&lt;-</span> <span class="st">&quot;https://cloud.r-project.org/src/contrib/Archive/curl/curl_2.0.tar.gz&quot;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">synchronise</span>(<span class="fu">resolve_url</span>(curl20_url))</span></code></pre></div>
<pre><code>## $url
## [1] &quot;file:// /private/var/folders/ph/fpcmzfd16rgbbk8mxvy9m2_h0000gn/T/RtmpGfFwqD/file16fb61c667cae/curl_2.0.tar.gz&quot;
## 
## $description
## Type: Package
## Package: curl
## Title: A Modern and Flexible Web Client for R
## Version: 2.0
## Authors@R (parsed):
##     * Jeroen Ooms &lt;jeroen.ooms@stat.ucla.edu&gt; [cre, aut]
##     * Hadley Wickham &lt;hadley@rstudio.com&gt; [ctb]
##     * RStudio [cph]
## Author: Jeroen Ooms [cre, aut], Hadley Wickham [ctb], RStudio [cph]
## Maintainer: Jeroen Ooms &lt;jeroen.ooms@stat.ucla.edu&gt;
## Description: The curl() and curl_download() functions provide highly
##     configurable drop-in replacements for base url() and download.file()
##     with better performance, support for encryption (https, ftps), gzip
##     compression, authentication, and other libcurl goodies. The core of
##     the package implements a framework for performing fully customized
##     requests where data can be processed either in memory, on disk, or
##     streaming via the callback or connection interfaces. Some knowledge of
##     libcurl is recommended; for a more-user-friendly web client see the
##     &#39;httr&#39; package which builds on this package with http specific tools
##     and logic.
## License: MIT + file LICENSE
## URL: https://github.com/jeroenooms/curl#readme
## BugReports: https://github.com/jeroenooms/curl/issues
## Depends:
##     R (&gt;= 3.0.0)
## Suggests:
##     jsonlite,
##     knitr,
##     magrittr,
##     rmarkdown,
##     testthat (&gt;= 1.0.0)
## VignetteBuilder:
##     knitr
## Date/Publication: 2016-09-17 00:42:17
## LazyData: true
## NeedsCompilation: yes
## Packaged: 2016-09-16 15:48:22 UTC; jeroen
## Repository: CRAN
## RoxygenNote: 5.0.1
## SystemRequirements: libcurl: libcurl-devel (rpm) or libcurl4-openssl-dev
##     (deb).</code></pre>
<p>Now combine the two functions:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">synchronise</span>(<span class="fu">when_all</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_gh</span>(<span class="st">&quot;jeroen/curl&quot;</span>),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_gh</span>(<span class="st">&quot;ropensci/magick&quot;</span>),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_url</span>(curl20_url)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(res)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<p>Errors bubble up to the top level, other downloads are cancelled
automatically (unless they are already completed of course), and an
error is thrown from <code>synchronise()</code>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">synchronise</span>(<span class="fu">when_all</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resolve_gh</span>(<span class="st">&quot;jeroen/curl&quot;</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resolve_gh</span>(<span class="st">&quot;ropensci/magick&quot;</span>),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resolve_url</span>(curl20_url),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resolve_url</span>(<span class="st">&quot;https://httpbin.org/delay/2&quot;</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  )),</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) e</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## &lt;async error: Line starting &#39;{ ...&#39; is malformed!
##  in *parent* callback of `http_get(url, file = dest)$then(http_stop_for_status)$then` at ./&lt;text&gt;:4:3&gt;</code></pre>
<p>But we can also handle errors locally, at any point we wish. E.g. we
can simply return <code>NULL</code> values for the failed packages.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">synchronise</span>(<span class="fu">when_all</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_gh</span>(<span class="st">&quot;jeroen/curl&quot;</span>),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_gh</span>(<span class="st">&quot;ropensci/magickfoooooobar&quot;</span>)<span class="sc">$</span><span class="fu">catch</span>(<span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_url</span>(curl20_url),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve_url</span>(<span class="st">&quot;https://httpbin.org/status/401&quot;</span>)<span class="sc">$</span><span class="fu">catch</span>(<span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">1</span>]]<span class="sc">$</span>description<span class="sc">$</span><span class="fu">get</span>(<span class="st">&quot;Package&quot;</span>)</span></code></pre></div>
<pre><code>## Package 
##  &quot;curl&quot;</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">2</span>]]</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">3</span>]]<span class="sc">$</span>description<span class="sc">$</span><span class="fu">get</span>(<span class="st">&quot;Version&quot;</span>)</span></code></pre></div>
<pre><code>## Version 
##   &quot;2.0&quot;</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>res[[<span class="dv">4</span>]]</span></code></pre></div>
<pre><code>## NULL</code></pre>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
